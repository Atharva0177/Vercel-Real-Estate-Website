{% extends 'base.html' %}

{% block title %}{{ property.title }} - Premium Real Estate{% endblock %}

{% block extra_css %}
<style>
/* ===== PROPERTY DETAIL PAGE STYLES ===== */

/* Hero */
.property-hero {
  background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:#fff;
  padding:3rem 0 2rem;
  margin-top:70px;
}

/* Breadcrumb */
.breadcrumb-wrapper {padding:0;margin:0;}
.breadcrumb-nav {
  display:flex;align-items:center;gap:.5rem;
  margin-bottom:.8rem;font-size:.9rem;
}
.breadcrumb-nav a {color:rgba(255,255,255,.9);text-decoration:none;display:inline-flex;align-items:center;gap:.3rem;transition:.3s;}
.breadcrumb-nav a:hover {color:#fff;}
.breadcrumb-sep {color:rgba(255,255,255,.6);}
.breadcrumb-title {
  margin:0;color:#fff;font-size:1.4rem;font-weight:600;line-height:1.3;font-family:'Playfair Display',serif;
}

/* Layout */
.property-details-section {padding:3rem 0;background:#f5f6fa;}
.property-details-grid {
  display:grid;grid-template-columns:1.5fr 1fr;gap:2rem;max-width:1400px;margin:0 auto;
}

@media (max-width:1024px){
  .property-details-grid{grid-template-columns:1fr;}
}

/* Gallery */
.property-gallery {
  background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:2rem;
}
.gallery-main {position:relative;height:500px;background:#000;overflow:hidden;}
.gallery-main img {width:100%;height:100%;object-fit:cover;}
.gallery-nav, .favorite-btn, .fullscreen-btn {
  position:absolute;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.9);transition:.3s;z-index:10;
}
.gallery-nav {width:50px;height:50px;top:50%;transform:translateY(-50%);}
.gallery-nav.prev {left:20px;}
.gallery-nav.next {right:20px;}
.gallery-nav:hover {background:#fff;transform:translateY(-50%) scale(1.1);}
.favorite-btn {top:20px;left:20px;width:50px;height:50px;font-size:1.5rem;color:#666;}
.favorite-btn.active {color:#e74c3c;}
.favorite-btn:hover, .fullscreen-btn:hover {transform:scale(1.1);background:#fff;}
.fullscreen-btn {bottom:20px;right:20px;width:50px;height:50px;font-size:1.2rem;}
.stats-badge {
  display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .9rem;background:rgba(255,255,255,.9);
  border-radius:25px;font-size:.8rem;font-weight:600;color:#2c3e50;backdrop-filter:blur(10px);
}
.gallery-thumbnails {
  display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));
  gap:.6rem;padding:1rem;background:#f5f5f5;
}
.gallery-thumbnails img {
  width:100%;height:80px;object-fit:cover;border-radius:10px;cursor:pointer;border:3px solid transparent;transition:.3s;
}
.gallery-thumbnails img:hover {transform:scale(1.05);border-color:#764ba2;}
.gallery-thumbnails img.active {border-color:#667eea;}

/* Property Info */
.property-info {
  background:#fff;border-radius:20px;padding:2rem;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:2rem;
}
.property-header {
  display:flex;justify-content:space-between;align-items:flex-start;gap:2rem;margin-bottom:2rem;
  padding-bottom:2rem;border-bottom:2px solid #f0f0f0;
}
.property-type-badge {
  display:inline-block;background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;padding:.4rem 1rem;border-radius:20px;font-size:.75rem;font-weight:600;
}
.property-header h1 {margin:.6rem 0;font-size:2.1rem;color:#2c3e50;line-height:1.15;}
.property-location {display:flex;align-items:center;gap:.5rem;color:#555;font-size:1rem;margin:0;}
.property-location i {color:#764ba2;}
.property-price-box {text-align:right;}
.price-label {display:block;font-size:.75rem;color:#555;margin-bottom:.3rem;text-transform:uppercase;letter-spacing:.5px;}
.price {display:block;font-size:2.3rem;font-weight:700;color:#667eea;font-family:'Poppins',sans-serif;}

.quick-stats {
  display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem;
}
.stat-box {
  background:#f8f9fb;padding:1.2rem;border-radius:15px;display:flex;align-items:center;gap:1rem;
}
.stat-box i {font-size:1.8rem;color:#667eea;}
.stat-value {display:block;font-size:1.2rem;font-weight:700;color:#2c3e50;}
.stat-label {display:block;font-size:.7rem;color:#777;text-transform:uppercase;letter-spacing:.5px;}

@media (max-width:768px){
  .property-header{flex-direction:column}
  .property-price-box{text-align:left}
  .quick-stats{grid-template-columns:repeat(2,1fr)}
  .stat-box{flex-direction:column;text-align:center}
  .gallery-main{height:300px}
}

@media (max-width:480px){
  .quick-stats{grid-template-columns:1fr}
  .gallery-main{height:250px}
  .breadcrumb-nav{font-size:.7rem}
  .breadcrumb-title{font-size:.95rem}
}

/* Description / Features */
.section-block {margin-bottom:2rem;}
.section-block h2 {
  font-size:1.5rem;margin-bottom:1rem;color:#2c3e50;font-weight:600;display:flex;align-items:center;gap:.6rem;
}
.section-block h2 i {color:#667eea;font-size:1.2rem;}
.property-description p {line-height:1.7;color:#555;font-size:.95rem;}
.features-list {display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.8rem;}
.feature-item {
  display:flex;align-items:flex-start;gap:.8rem;padding:.8rem 1rem;background:#f7f9fc;border-radius:10px;
  font-size:.85rem;color:#2c3e50;
}
.feature-item i {color:#38c172;font-size:1rem;margin-top:.15rem;}

/* Documents */
.property-documents .documents-grid {
  display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;
}
.document-card {
  background:#fff;border:2px solid #eef1f5;border-radius:15px;padding:1rem;display:flex;flex-direction:column;gap:.8rem;
  transition:.3s;position:relative;
}
.document-card:hover {border-color:#667eea;box-shadow:0 5px 18px rgba(0,0,0,.07);transform:translateY(-3px);}
.document-icon {
  width:55px;height:55px;border-radius:12px;display:flex;align-items:center;justify-content:center;
  font-size:1.5rem;color:#fff;
}
.doc-legal {background:linear-gradient(135deg,#667eea,#764ba2);}
.doc-floor {background:linear-gradient(135deg,#f093fb,#f5576c);}
.doc-noc {background:linear-gradient(135deg,#4facfe,#00f2fe);}
.doc-approval {background:linear-gradient(135deg,#43e97b,#38f9d7);}
.doc-other {background:linear-gradient(135deg,#fa709a,#fee140);}
.document-info h4 {margin:0 0 .4rem;font-size:.95rem;color:#2c3e50;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.document-meta {display:flex;flex-wrap:wrap;gap:.5rem;font-size:.65rem;color:#666;}
.document-meta span {display:inline-flex;align-items:center;gap:.3rem;background:#f0f2f6;padding:.3rem .6rem;border-radius:8px;}
.document-badge {
  position:absolute;top:10px;right:10px;font-size:.6rem;padding:.3rem .55rem;border-radius:8px;
  font-weight:600;letter-spacing:.5px;display:inline-flex;align-items:center;gap:.3rem;
}
.doc-public {background:#d4edda;color:#155724;}
.doc-private {background:#fff3cd;color:#856404;}
.document-actions {display:flex;gap:.5rem;}
.btn-doc {
  flex:1;display:flex;justify-content:center;align-items:center;gap:.4rem;padding:.55rem .6rem;
  font-size:.7rem;font-weight:600;border-radius:8px;border:none;cursor:pointer;transition:.3s;
}
.btn-download {background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;}
.btn-download:hover {filter:brightness(1.1);}
.btn-preview {background:#f0f2f6;color:#333;}
.btn-preview:hover {background:#e2e6ec;}

/* Document Modal */
.document-modal {
  position:fixed;inset:0;display:none;z-index:10000;align-items:center;justify-content:center;
}
.document-modal.open {display:flex;}
.document-modal .overlay {
  position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
}
.document-modal .content {
  position:relative;background:#fff;border-radius:18px;width:min(1000px,94vw);height:88vh;
  display:flex;flex-direction:column;box-shadow:0 30px 60px rgba(0,0,0,.4);overflow:hidden;
}
.document-modal header {
  display:flex;justify-content:space-between;align-items:center;padding:1rem 1.3rem;border-bottom:1px solid #eee;
  background:#f8f9fa;
}
.document-modal header h3 {margin:0;font-size:1rem;font-weight:600;color:#2c3e50;display:flex;align-items:center;gap:.5rem;}
.document-modal header button {
  background:transparent;border:none;font-size:1.2rem;cursor:pointer;color:#555;transition:.3s;
}
.document-modal header button:hover {color:#000;}
.document-modal .body {flex:1;overflow:hidden;}
#documentPreviewFrame {width:100%;height:100%;border:0;}

@media (max-width:768px){
  .property-documents .documents-grid{grid-template-columns:1fr}
  .document-card{padding:.9rem}
  .document-actions{flex-direction:column}
}

/* Sidebar boxes */
.property-sidebar {position:sticky;top:90px;align-self:flex-start;}
.sidebar-box {
  background:#fff;border-radius:20px;padding:1.6rem;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:1.6rem;
}
.sidebar-box h3 {
  margin:0 0 1rem;font-size:1.1rem;font-weight:600;color:#2c3e50;display:flex;align-items:center;gap:.6rem;
}
.sidebar-box h3 i {color:#667eea;font-size:1rem;}
.share-buttons {display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;}
.social-share-btn {
  width:42px;height:42px;border:2px solid #d9dde3;border-radius:50%;display:flex;align-items:center;justify-content:center;
  background:#fff;font-size:1rem;cursor:pointer;transition:.3s;color:#445;
}
.social-share-btn:hover {transform:translateY(-3px);}
.social-share-btn.facebook:hover {background:#3b5998;color:#fff;border-color:#3b5998;}
.social-share-btn.twitter:hover {background:#1da1f2;color:#fff;border-color:#1da1f2;}
.social-share-btn.whatsapp:hover {background:#25D366;color:#fff;border-color:#25D366;}
.social-share-btn.linkedin:hover {background:#0077b5;color:#fff;border-color:#0077b5;}
.social-share-btn.copy:hover {background:#764ba2;color:#fff;border-color:#764ba2;}

.enquiry-form .form-group {margin-bottom:.9rem;}
.enquiry-form .form-control {
  width:100%;padding:.8rem;border:2px solid #d9dde3;border-radius:10px;font-family:inherit;transition:.25s;
}
.enquiry-form .form-control:focus {
  outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15);
}
.btn-primary.btn-block {
  width:100%;display:flex;justify-content:center;align-items:center;gap:.5rem;padding:.85rem 1rem;
  border-radius:12px;font-weight:600;font-size:.9rem;
}
.contact-methods {display:flex;flex-direction:column;gap:.7rem;}
.contact-btn {
  display:flex;align-items:center;gap:.6rem;padding:.75rem .9rem;border:2px solid #d9dde3;
  border-radius:10px;background:#fff;color:#2c3e50;font-weight:500;text-decoration:none;transition:.25s;
}
.contact-btn:hover {background:#f0f2f6;border-color:#667eea;}
.contact-btn.whatsapp {background:#25D366;color:#fff;border-color:#25D366;}
.contact-btn.whatsapp:hover {background:#128C7E;}

.agent-info {
  display:flex;align-items:center;gap:1rem;padding:1rem;background:#f7f9fc;border-radius:12px;margin-bottom:1rem;
}
.agent-avatar {
  width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.6rem;
}

/* Booking Modal (existing styling condensed) */
.booking-modal {display:none;position:fixed;inset:0;z-index:10000;align-items:center;justify-content:center;}
.booking-modal-overlay {position:absolute;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);}
.booking-modal-content {
  position:relative;background:#fff;border-radius:25px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;
  box-shadow:0 30px 60px rgba(0,0,0,.5);
}
.booking-modal-header {
  background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:1.8rem 2rem;border-radius:25px 25px 0 0;
  display:flex;justify-content:space-between;align-items:flex-start;
}
.booking-modal-header h2 {margin:0 0 .4rem;font-size:1.6rem;display:flex;gap:.6rem;align-items:center;}
.modal-close-btn {
  background:rgba(255,255,255,.25);width:42px;height:42px;border:none;border-radius:50%;cursor:pointer;
  display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;transition:.3s;
}
.modal-close-btn:hover {background:rgba(255,255,255,.35);transform:rotate(90deg);}
.booking-property-info {display:flex;gap:1.2rem;padding:1.3rem 1.8rem;background:#f5f6fa;align-items:center;}
.booking-property-image {width:120px;height:90px;border-radius:15px;overflow:hidden;flex-shrink:0;}
.booking-property-image img {width:100%;height:100%;object-fit:cover;}
.booking-property-details h4 {margin:0 0 .4rem;font-size:1.05rem;color:#2c3e50;}
.booking-price {background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:.35rem .9rem;border-radius:18px;font-size:.85rem;font-weight:600;}

.booking-form {padding:1.6rem 1.8rem;}
.form-row {display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin-bottom:1.2rem;}
@media (max-width:640px){.form-row{grid-template-columns:1fr}}
.form-group label {font-weight:600;font-size:.8rem;color:#2c3e50;display:flex;gap:.4rem;align-items:center;margin-bottom:.4rem;}
.visitor-counter {display:flex;align-items:center;gap:.5rem;}
.counter-btn {
  width:38px;height:38px;border:2px solid #667eea;background:#fff;border-radius:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;color:#667eea;font-size:.9rem;transition:.3s;
}
.counter-btn:hover {background:#667eea;color:#fff;}
.visitor-input {text-align:center;font-weight:600;font-size:1rem;color:#2c3e50;border:2px solid #d9dde3;border-radius:10px;padding:.7rem .5rem;}
.booking-summary {
  background:linear-gradient(135deg,rgba(102,126,234,.12),rgba(118,75,162,.12));
  padding:1.1rem;border-radius:15px;margin-bottom:1rem;border-left:4px solid #667eea;
}
.summary-item {display:flex;align-items:center;gap:.6rem;font-size:.75rem;margin-bottom:.5rem;color:#2c3e50;}
.summary-item i {color:#667eea;font-size:.85rem;}
.modal-actions {display:flex;gap:.7rem;justify-content:flex-end;margin-top:.5rem;}
.modal-actions .btn {padding:.75rem 1.4rem;border-radius:12px;font-weight:600;font-size:.8rem;display:flex;align-items:center;gap:.5rem;border:none;cursor:pointer;}
.btn-secondary {background:#d9dde3;color:#2c3e50;}
.btn-secondary:hover {background:#c7ccd2;}
.btn-primary {background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 5px 15px rgba(102,126,234,.4);}
.btn-primary:hover {filter:brightness(1.1);transform:translateY(-2px);}

/* Mobile adjustments */
@media (max-width:768px){
  .property-hero{padding:2rem 1rem 1.4rem}
  .property-details-section{padding:2.2rem 0}
  .property-sidebar{position:static}
  .booking-property-info{flex-direction:column;text-align:center}
  .booking-property-image{width:100%;height:160px}
  .modal-actions{flex-direction:column}
  .modal-actions .btn{width:100%;justify-content:center}
}

/* Utility classes */
.fade-in-up {animation:fadeInUp .6s both;}
@keyframes fadeInUp {
  0% {opacity:0;transform:translateY(20px);}
  100% {opacity:1;transform:translateY(0);}
}

/* Leaflet map container fix to avoid bleed */
#propertyMap { height: 450px; border-radius: 15px; overflow: hidden; }
</style>
{% endblock %}

{% block content %}
<section class="property-hero">
  <div class="container">
    <nav class="breadcrumb-wrapper fade-in-up" aria-label="Breadcrumb">
      <div class="breadcrumb-nav">
        <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a>
        <span class="breadcrumb-sep">/</span>
        <a href="{{ url_for('properties') }}">Properties</a>
      </div>
      <h1 class="breadcrumb-title">{{ property.title }}</h1>
    </nav>
  </div>
</section>

<section class="property-details-section">
  <div class="container">
    <div class="property-details-grid">
      <!-- MAIN -->
      <div class="property-main">
        <!-- Gallery -->
        <div class="property-gallery fade-in-up">
          <div class="gallery-main" id="galleryMain">
            {% if property.images %}
              <img src="{{ property.images[0].image_url }}" alt="{{ property.title }}" id="mainImage">
            {% else %}
              <img src="https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?w=1200" alt="{{ property.title }}" id="mainImage">
            {% endif %}

            {% if session.user_id %}
            <button class="favorite-btn {% if is_favorited %}active{% endif %}" onclick="toggleFavorite({{ property.id }})">
              <i class="{% if is_favorited %}fas{% else %}far{% endif %} fa-heart"></i>
            </button>
            {% else %}
            <button class="favorite-btn" onclick="window.location.href='{{ url_for('user_login') }}'">
              <i class="far fa-heart"></i>
            </button>
            {% endif %}

            {% if property.images and property.images|length > 1 %}
              <button class="gallery-nav prev" onclick="changeImage(-1)"><i class="fas fa-chevron-left"></i></button>
              <button class="gallery-nav next" onclick="changeImage(1)"><i class="fas fa-chevron-right"></i></button>
            {% endif %}

            <button class="fullscreen-btn" onclick="openFullscreen()"><i class="fas fa-expand"></i></button>

            <div style="position:absolute;bottom:20px;left:20px;display:flex;gap:.7rem;flex-wrap:wrap;z-index:10;">
              <div class="stats-badge"><i class="fas fa-eye"></i>{{ property.views }} views</div>
              <div class="stats-badge"><i class="fas fa-share-alt"></i>{{ property.shares or 0 }} shares</div>
            </div>
          </div>

          {% if property.images and property.images|length > 1 %}
          <div class="gallery-thumbnails">
            {% for image in property.images %}
              <img src="{{ image.image_url }}"
                   alt="View {{ loop.index }}"
                   onclick="setMainImage('{{ image.image_url }}', this)"
                   class="{% if loop.first %}active{% endif %}"
                   data-index="{{ loop.index0 }}">
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Info -->
        <div class="property-info fade-in-up">
          <div class="property-header">
            <div>
              <span class="property-type-badge">{{ property.property_type }}</span>
              <h1>{{ property.title }}</h1>
              <p class="property-location"><i class="fas fa-map-marker-alt"></i>{{ property.location }}</p>
            </div>
            <div class="property-price-box">
              <span class="price-label">Price</span>
              <span class="price">₹{{ "{:,.0f}".format(property.price) }}</span>
            </div>
          </div>

            <div class="quick-stats">
              <div class="stat-box">
                <i class="fas fa-ruler-combined"></i>
                <div>
                  <span class="stat-value">{{ property.area|int }}</span>
                  <span class="stat-label">SQ FT</span>
                </div>
              </div>
              <div class="stat-box">
                <i class="fas fa-tag"></i>
                <div>
                  <span class="stat-value">{{ property.status }}</span>
                  <span class="stat-label">Status</span>
                </div>
              </div>
              <div class="stat-box">
                <i class="fas fa-calculator"></i>
                <div>
                  <span class="stat-value">₹{{ "{:,.0f}".format(property.price / property.area) }}</span>
                  <span class="stat-label">Per Sq Ft</span>
                </div>
              </div>
              <div class="stat-box">
                <i class="fas fa-calendar"></i>
                <div>
                  <span class="stat-value">{{ property.created_at.strftime('%b %Y') }}</span>
                  <span class="stat-label">Listed</span>
                </div>
              </div>
            </div>

            <!-- Description -->
            <div class="section-block property-description">
              <h2><i class="fas fa-info-circle"></i> About This Property</h2>
              <p>{{ property.description }}</p>
            </div>

            <!-- Features -->
            <div class="section-block property-features">
              <h2><i class="fas fa-list"></i> Property Details</h2>
              <div class="features-list">
                <div class="feature-item"><i class="fas fa-check-circle"></i><span><strong>Type:</strong> {{ property.property_type }}</span></div>
                <div class="feature-item"><i class="fas fa-check-circle"></i><span><strong>Area:</strong> {{ property.area|int }} sq ft</span></div>
                <div class="feature-item"><i class="fas fa-check-circle"></i><span><strong>Location:</strong> {{ property.location }}</span></div>
                <div class="feature-item"><i class="fas fa-check-circle"></i><span><strong>Status:</strong> {{ property.status }}</span></div>
                <div class="feature-item"><i class="fas fa-check-circle"></i><span><strong>Address:</strong> {{ property.address }}</span></div>
                <div class="feature-item"><i class="fas fa-check-circle"></i><span><strong>Listed:</strong> {{ property.created_at.strftime('%d %b %Y') }}</span></div>
              </div>
            </div>

            <!-- Documents -->
            {% if property.documents %}
            <div class="section-block property-documents">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <h2 style="margin-bottom:0;"><i class="fas fa-file-alt"></i> Property Documents</h2>
                {% if property.documents|length > 1 %}
                <a href="{{ url_for('download_all_documents', property_id=property.id) }}" class="btn btn-primary" style="padding:.65rem 1.2rem;font-size:.85rem;display:inline-flex;align-items:center;gap:.5rem;">
                  <i class="fas fa-file-archive"></i> Download All ({{ property.documents|length }} files)
                </a>
                {% endif %}
              </div>
              <div class="documents-grid">
                {% for document in property.documents %}
                  <div class="document-card">
                    <div class="document-icon
                      {% if 'LEGAL' in document.document_type %}doc-legal
                      {% elif 'FLOOR' in document.document_type %}doc-floor
                      {% elif 'NOC' in document.document_type %}doc-noc
                      {% elif 'APPROVAL' in document.document_type %}doc-approval
                      {% else %}doc-other{% endif %}">
                      <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="document-info">
                      <h4 title="{{ document.document_name }}">{{ document.document_name }}</h4>
                      <div class="document-meta">
                        <span><i class="fas fa-tag"></i>{{ document.document_type }}</span>
                        {% if document.file_size %}<span><i class="fas fa-hdd"></i>{{ document.file_size }}</span>{% endif %}
                        {% if document.uploaded_at %}<span><i class="fas fa-clock"></i>{{ document.uploaded_at.strftime('%d %b %Y') }}</span>{% endif %}
                      </div>
                    </div>
                    <span class="document-badge doc-public"><i class="fas fa-globe"></i> Public</span>
                    <div class="document-actions">
                      <a href="{{ url_for('download_document', doc_id=document.id) }}" class="btn-doc btn-download" title="Download">
                        <i class="fas fa-download"></i> Download
                      </a>
                      {% if document.document_url.lower().endswith('.pdf') %}
                      <button class="btn-doc btn-preview" onclick="previewDocument('{{ url_for('static', filename=document.document_url) }}')" title="Preview">
                        <i class="fas fa-eye"></i> Preview
                      </button>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Videos -->
            {% if property.videos %}
            <div class="section-block property-videos">
              <h2><i class="fas fa-video"></i> Video Tour</h2>
              <div class="videos-grid" style="display:grid;gap:1rem;">
                {% for video in property.videos %}
                <div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;border-radius:15px;overflow:hidden;">
                  {% if 'youtube.com' in video.video_url or 'youtu.be' in video.video_url %}
                    {% set video_id = video.video_url.split('v=')[-1].split('&')[0] if 'v=' in video.video_url else video.video_url.split('/')[-1] %}
                    <iframe src="https://www.youtube.com/embed/{{ video_id }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe>
                  {% else %}
                    <video controls style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;">
                      <source src="{{ video.video_url }}" type="video/mp4">
                    </video>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Location Map (OpenStreetMap via Leaflet, free) -->
            {% if property.latitude and property.longitude %}
            <div class="section-block property-map">
              <h2><i class="fas fa-map-marked-alt"></i> Location on Map</h2>
              <div id="propertyMap"></div>
              <div style="margin-top:.75rem;">
                <a target="_blank"
                   href="https://www.openstreetmap.org/?mlat={{ property.latitude }}&mlon={{ property.longitude }}#map=15/{{ property.latitude }}/{{ property.longitude }}"
                   class="btn btn-primary" style="display:inline-flex;align-items:center;gap:.5rem;">
                  <i class="fas fa-route"></i> Open in OpenStreetMap
                </a>
              </div>
            </div>
            {% endif %}
        </div>
      </div>

      <!-- SIDEBAR -->
      <div class="property-sidebar">
        <!-- Share -->
        <div class="sidebar-box fade-in-up">
          <h3><i class="fas fa-share-alt"></i> Share Property</h3>
          <div class="share-buttons">
            <button class="social-share-btn facebook" onclick="shareOn('facebook')" title="Facebook"><i class="fab fa-facebook-f"></i></button>
            <button class="social-share-btn twitter" onclick="shareOn('twitter')" title="Twitter"><i class="fab fa-twitter"></i></button>
            <button class="social-share-btn whatsapp" onclick="shareOn('whatsapp')" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
            <button class="social-share-btn linkedin" onclick="shareOn('linkedin')" title="LinkedIn"><i class="fab fa-linkedin-in"></i></button>
            <button class="social-share-btn copy" onclick="copyLink()" title="Copy Link"><i class="fas fa-link"></i></button>
          </div>
        </div>

        <!-- Book Site Visit -->
        {% if session.user_id and property.status == 'Available' %}
        <div class="sidebar-box fade-in-up">
          <h3><i class="fas fa-calendar-check"></i> Schedule Site Visit</h3>
          <p style="font-size:.82rem;color:#555;">Book a personalized property tour.</p>
          <button onclick="openBookingModal()" class="btn btn-primary btn-block">
            <i class="fas fa-calendar-alt"></i> Book Site Visit
          </button>
        </div>
        {% endif %}

        <!-- Enquiry Form -->
        <div class="sidebar-box fade-in-up">
          <h3><i class="fas fa-envelope"></i> Send Inquiry</h3>
          <p style="font-size:.82rem;color:#555;">Interested? Reach out to us.</p>
          <form method="post" action="{{ url_for('submit_enquiry') }}" class="enquiry-form">
            {{ form.hidden_tag() }}
            <input type="hidden" name="property_id" value="{{ property.id }}">
            <div class="form-group">{{ form.name(class="form-control", placeholder="Your Name *") }}</div>
            <div class="form-group">{{ form.email(class="form-control", placeholder="Email Address *") }}</div>
            <div class="form-group">{{ form.phone(class="form-control", placeholder="Phone Number *") }}</div>
            <div class="form-group">{{ form.message(class="form-control", rows="4", placeholder="Your Message *") }}</div>
            <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-paper-plane"></i> Send Inquiry</button>
          </form>
        </div>

        <!-- Contact Agent -->
        <div class="sidebar-box fade-in-up">
          <h3><i class="fas fa-phone"></i> Contact Agent</h3>
            <div class="agent-info">
              <div class="agent-avatar"><i class="fas fa-user-tie"></i></div>
              <div>
                <h4 style="margin:0;font-size:.95rem;">Premium Estate</h4>
                <p style="margin:.2rem 0 0;font-size:.7rem;color:#666;">Real Estate Consultant</p>
              </div>
            </div>
            <div class="contact-methods">
              <a href="tel:+919876543210" class="contact-btn"><i class="fas fa-phone"></i> +91 98765 43210</a>
              <a href="mailto:info@premiumestate.com" class="contact-btn"><i class="fas fa-envelope"></i> info@premiumestate.com</a>
              <a href="https://wa.me/919876543210?text=Hi,%20I'm%20interested%20in%20{{ property.title|urlencode }}" target="_blank" class="contact-btn whatsapp">
                <i class="fab fa-whatsapp"></i> WhatsApp
              </a>
            </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Booking Modal -->
{% if session.user_id %}
<div id="bookingModal" class="booking-modal">
  <div class="booking-modal-overlay" onclick="closeBookingModal()"></div>
  <div class="booking-modal-content">
    <div class="booking-modal-header">
      <div>
        <h2><i class="fas fa-calendar-check"></i> Schedule Site Visit</h2>
        <p style="margin:0;font-size:.8rem;opacity:.9;">Book your personalized property tour</p>
      </div>
      <button onclick="closeBookingModal()" class="modal-close-btn"><i class="fas fa-times"></i></button>
    </div>
    <div class="booking-property-info">
      <div class="booking-property-image">
        {% if property.images %}
          <img src="{{ property.images[0].image_url }}" alt="{{ property.title }}">
        {% else %}
          <img src="https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?w=400" alt="{{ property.title }}">
        {% endif %}
      </div>
      <div class="booking-property-details">
        <h4>{{ property.title }}</h4>
        <p style="margin:0 0 .4rem;font-size:.75rem;color:#555;"><i class="fas fa-map-marker-alt"></i> {{ property.location }}</p>
        <span class="booking-price">₹{{ "{:,.0f}".format(property.price) }}</span>
      </div>
    </div>
    <form method="post" action="{{ url_for('create_booking', property_id=property.id) }}" class="booking-form">
      {{ booking_form.hidden_tag() }}
      <div class="form-row">
        <div class="form-group">
          <label><i class="fas fa-calendar"></i> Visit Date</label>
          {{ booking_form.booking_date(class="form-control date-picker") }}
        </div>
        <div class="form-group">
          <label><i class="fas fa-clock"></i> Preferred Time</label>
          {{ booking_form.booking_time(class="form-control") }}
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label><i class="fas fa-user"></i> Your Name</label>
          {{ booking_form.visitor_name(class="form-control", value=session.user_name) }}
        </div>
        <div class="form-group">
          <label><i class="fas fa-users"></i> Visitors</label>
          <div class="visitor-counter">
            <button type="button" class="counter-btn" onclick="decrementVisitors()"><i class="fas fa-minus"></i></button>
            {{ booking_form.number_of_visitors(class="form-control visitor-input") }}
            <button type="button" class="counter-btn" onclick="incrementVisitors()"><i class="fas fa-plus"></i></button>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email</label>
          {{ booking_form.visitor_email(class="form-control", value=session.user_email) }}
        </div>
        <div class="form-group">
          <label><i class="fas fa-phone"></i> Phone</label>
          {{ booking_form.visitor_phone(class="form-control") }}
        </div>
      </div>
      <div class="form-group">
        <label><i class="fas fa-comment"></i> Notes (Optional)</label>
        {{ booking_form.message(class="form-control", rows="3", placeholder="Any specific requirements...") }}
      </div>
      <div class="booking-summary">
        <div class="summary-item"><i class="fas fa-info-circle"></i><span>We will confirm within 24 hours</span></div>
        <div class="summary-item"><i class="fas fa-shield-alt"></i><span>Your information is secure</span></div>
      </div>
      <div class="modal-actions">
        <button type="button" onclick="closeBookingModal()" class="btn btn-secondary"><i class="fas fa-times"></i> Cancel</button>
        <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Confirm Booking</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Document Preview Modal -->
<div id="documentPreviewModal" class="document-modal">
  <div class="overlay" data-close-doc></div>
  <div class="content" role="dialog" aria-modal="true">
    <header>
      <h3><i class="fas fa-file-alt"></i> Document Preview</h3>
      <button type="button" data-close-doc>&times;</button>
    </header>
    <div class="body">
      <iframe id="documentPreviewFrame" src="" title="Document Preview"></iframe>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet (OpenStreetMap) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
/* ===== Gallery Functionality ===== */
let currentImageIndex = 0;
const images = [
  {% if property.images %}
    {% for image in property.images %}
      "{{ image.image_url }}"{% if not loop.last %},{% endif %}
    {% endfor %}
  {% else %}
    "https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?w=1200"
  {% endif %}
];

function setMainImage(url, thumb){
  const img = document.getElementById('mainImage');
  img.src = url;
  const thumbs = document.querySelectorAll('.gallery-thumbnails img');
  thumbs.forEach(i=>i.classList.remove('active'));
  if(thumb){
    thumb.classList.add('active');
    currentImageIndex = parseInt(thumb.dataset.index);
  }
}
function changeImage(dir){
  currentImageIndex = (currentImageIndex + dir + images.length) % images.length;
  const thumbs = document.querySelectorAll('.gallery-thumbnails img');
  if(thumbs[currentImageIndex]) setMainImage(images[currentImageIndex], thumbs[currentImageIndex]);
  else document.getElementById('mainImage').src = images[currentImageIndex];
}
function openFullscreen(){
  const elem = document.getElementById('galleryMain');
  if(elem.requestFullscreen) elem.requestFullscreen();
  else if(elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
}

/* ===== Favorite Toggle ===== */
function toggleFavorite(pid){
  fetch('/favorite/toggle/' + pid, {method:'POST'})
    .then(r=>r.json())
    .then(data=>{
      const btn = document.querySelector('.favorite-btn');
      const icon = btn.querySelector('i');
      if(data.status==='added'){
        icon.classList.remove('far'); icon.classList.add('fas'); btn.classList.add('active');
      } else {
        icon.classList.remove('fas'); icon.classList.add('far'); btn.classList.remove('active');
      }
      alert(data.message);
    }).catch(()=>alert('Failed to update favorite.'));
}

/* ===== Share ===== */
const propertyUrl = window.location.href;
const propertyTitle = "{{ property.title|escape }}";
function shareOn(platform){
  const url = encodeURIComponent(propertyUrl);
  const text = encodeURIComponent('Check out this property: ' + propertyTitle);
  let shareUrl='';
  switch(platform){
    case 'facebook': shareUrl=`https://www.facebook.com/sharer/sharer.php?u=${url}`;break;
    case 'twitter': shareUrl=`https://twitter.com/intent/tweet?url=${url}&text=${text}`;break;
    case 'whatsapp': shareUrl=`https://wa.me/?text=${text}%20${url}`;break;
    case 'linkedin': shareUrl=`https://www.linkedin.com/sharing/share-offsite/?url=${url}`;break;
  }
  if(shareUrl) window.open(shareUrl,'_blank','width=600,height=400');
}
function copyLink(){
  navigator.clipboard.writeText(propertyUrl).then(()=>alert('Link copied!')).catch(()=>alert('Copy failed'));
}

/* ===== Booking Modal ===== */
function openBookingModal(){
  const m = document.getElementById('bookingModal');
  if(m){m.style.display='flex';document.body.style.overflow='hidden';}
}
function closeBookingModal(){
  const m = document.getElementById('bookingModal');
  if(m){m.style.display='none';document.body.style.overflow='auto';}
}
function incrementVisitors(){
  const input=document.getElementById('number_of_visitors');
  let v=parseInt(input.value)||1;
  if(v<10) input.value=v+1;
}
function decrementVisitors(){
  const input=document.getElementById('number_of_visitors');
  let v=parseInt(input.value)||1;
  if(v>1) input.value=v-1;
}
document.addEventListener('DOMContentLoaded',function(){
  const dateInput=document.querySelector('.date-picker');
  if(dateInput){
    const tomorrow=new Date();
    tomorrow.setDate(tomorrow.getDate()+1);
    dateInput.min=tomorrow.toISOString().split('T')[0];
  }
});

/* ===== Document Preview ===== */
function previewDocument(url){
  const modal=document.getElementById('documentPreviewModal');
  const frame=document.getElementById('documentPreviewFrame');
  frame.src=url;
  modal.classList.add('open');
  document.body.style.overflow='hidden';
}
function closeDocumentPreview(){
  const modal=document.getElementById('documentPreviewModal');
  const frame=document.getElementById('documentPreviewFrame');
  frame.src='';
  modal.classList.remove('open');
  document.body.style.overflow='auto';
}
document.querySelectorAll('[data-close-doc]').forEach(el=>el.addEventListener('click',closeDocumentPreview));

/* ===== OpenStreetMap (Leaflet) ===== */
{% if property.latitude and property.longitude %}
(function initOSM(){
  const lat={{ property.latitude }};
  const lng={{ property.longitude }};
  const el = document.getElementById('propertyMap');
  if(!el) return;

  const map = L.map(el, { scrollWheelZoom: false }).setView([lat, lng], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const marker = L.marker([lat, lng]).addTo(map);
  marker.bindPopup(`<strong>{{ property.title|e }}</strong><br>{{ property.address|e }}`).openPopup();

  // Resize on tab visibility changes (safety)
  setTimeout(()=> map.invalidateSize(), 250);
})();
{% endif %}
</script>
{% endblock %}