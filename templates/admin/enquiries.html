{% extends 'base.html' %}

{% block title %}Enquiries - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
.table-message{
  max-width:320px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
  overflow:hidden;text-overflow:ellipsis;white-space:normal;
}
.table-actions{display:flex;gap:.5rem;align-items:center;}
/* Modal styling (same as earlier suggestion) */
.enquiry-modal{position:fixed;inset:0;display:none;z-index:10000;align-items:center;justify-content:center;}
.enquiry-modal.open{display:flex;}
.enquiry-modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);}
.enquiry-modal .content{position:relative;background:#fff;width:min(800px,92vw);border-radius:14px;box-shadow:0 30px 60px rgba(0,0,0,.2);overflow:hidden;}
.enquiry-modal header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid #eee;}
.enquiry-modal .body{padding:1rem 1.25rem;max-height:65vh;overflow:auto;}
.enquiry-meta{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1rem;}
.enquiry-full{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:.9rem;white-space:pre-wrap;line-height:1.6;}
.modal-actions{padding:.9rem 1.25rem;border-top:1px solid #eee;display:flex;gap:.5rem;justify-content:flex-end;}
@media (max-width:768px){.enquiry-meta{grid-template-columns:1fr;}}
</style>
{% endblock %}

{% block content %}
<div class="admin-layout">
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <i class="fas fa-user-shield"></i>
            <span>Admin Panel</span>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('admin_dashboard') }}" class="nav-item">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="{{ url_for('admin_properties') }}" class="nav-item">
                <i class="fas fa-building"></i> Properties
            </a>
            <a href="{{ url_for('admin_add_property') }}" class="nav-item">
                <i class="fas fa-plus-circle"></i> Add Property
            </a>
            <a href="{{ url_for('admin_enquiries') }}" class="nav-item active">
                <i class="fas fa-envelope"></i> Enquiries
            </a>
            <a href="{{ url_for('admin_bookings') }}" class="nav-item">
                <i class="fas fa-calendar-check"></i> Bookings
            </a>
            <a href="{{ url_for('index') }}" class="nav-item">
                <i class="fas fa-globe"></i> View Website
            </a>
            <a href="{{ url_for('admin_logout') }}" class="nav-item">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </aside>
    
    <main class="admin-main">
        <div class="admin-header">
            <h1><i class="fas fa-envelope"></i> Enquiries</h1>
            <div class="filter-buttons">
                <a href="{{ url_for('admin_enquiries') }}" class="btn {% if not request.args.get('status') %}btn-primary{% else %}btn-secondary{% endif %}">All</a>
                <a href="{{ url_for('admin_enquiries', status='New') }}" class="btn {% if request.args.get('status') == 'New' %}btn-primary{% else %}btn-secondary{% endif %}">New</a>
                <a href="{{ url_for('admin_enquiries', status='Contacted') }}" class="btn {% if request.args.get('status') == 'Contacted' %}btn-primary{% else %}btn-secondary{% endif %}">Contacted</a>
                <a href="{{ url_for('admin_enquiries', status='Closed') }}" class="btn {% if request.args.get('status') == 'Closed' %}btn-primary{% else %}btn-secondary{% endif %}">Closed</a>
            </div>
        </div>
        
        <div class="admin-content">
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th><th>Name</th><th>Email</th><th>Phone</th>
                            <th>Property</th><th>Message</th><th>Status</th><th>Date</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enquiry in enquiries.items %}
                        <tr>
                            <td>#{{ enquiry.id }}</td>
                            <td>{{ enquiry.name }}</td>
                            <td><a href="mailto:{{ enquiry.email }}">{{ enquiry.email }}</a></td>
                            <td><a href="tel:{{ enquiry.phone }}">{{ enquiry.phone }}</a></td>
                            <td>
                                {% if enquiry.property %}
                                <a href="{{ url_for('property_detail', id=enquiry.property.id) }}" target="_blank">
                                    {{ enquiry.property.title[:40] }}...
                                </a>
                                {% else %} General Enquiry {% endif %}
                            </td>
                            <td class="table-message" title="{{ enquiry.message }}">{{ enquiry.message }}</td>
                            <td><span class="status-badge status-{{ enquiry.status.lower() }}">{{ enquiry.status }}</span></td>
                            <td>{{ enquiry.created_at.strftime('%d %b %Y') }}</td>
                            <td class="table-actions">
                                <button class="btn btn-secondary btn-sm btn-view-enquiry"
                                    data-name="{{ enquiry.name }}"
                                    data-email="{{ enquiry.email }}"
                                    data-phone="{{ enquiry.phone }}"
                                    data-property="{{ enquiry.property.title if enquiry.property else 'General Enquiry' }}"
                                    data-message="{{ enquiry.message | replace('"','&quot;') }}">
                                    View
                                </button>
                                <form method="post" action="{{ url_for('update_enquiry_status', id=enquiry.id) }}" style="display:inline;">
                                    <select name="status" onchange="this.form.submit()" class="status-select">
                                        <option value="New" {% if enquiry.status == 'New' %}selected{% endif %}>New</option>
                                        <option value="Contacted" {% if enquiry.status == 'Contacted' %}selected{% endif %}>Contacted</option>
                                        <option value="Closed" {% if enquiry.status == 'Closed' %}selected{% endif %}>Closed</option>
                                    </select>
                                </form>
                                <!-- NEW: Delete -->
                                <form method="post" action="{{ url_for('delete_enquiry', id=enquiry.id) }}" style="display:inline;" onsubmit="return confirm('Delete this booking?');">
                                <button class="btn btn-danger btn-icon-sm" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if enquiries.pages > 1 %}
            <div class="pagination">
                {% if enquiries.has_prev %}
                <a href="{{ url_for('admin_enquiries', page=enquiries.prev_num, status=request.args.get('status', '')) }}" class="page-link">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
                {% endif %}
                {% for page_num in enquiries.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        {% if page_num == enquiries.page %}
                        <span class="page-link active">{{ page_num }}</span>
                        {% else %}
                        <a href="{{ url_for('admin_enquiries', page=page_num, status=request.args.get('status', '')) }}" class="page-link">{{ page_num }}</a>
                        {% endif %}
                    {% else %}
                        <span class="page-link">...</span>
                    {% endif %}
                {% endfor %}
                {% if enquiries.has_next %}
                <a href="{{ url_for('admin_enquiries', page=enquiries.next_num, status=request.args.get('status', '')) }}" class="page-link">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- Modal -->
<div id="enquiryModal" class="enquiry-modal" aria-hidden="true">
  <div class="overlay" data-close></div>
  <div class="content" role="dialog" aria-modal="true" aria-labelledby="enquiryModalTitle">
    <header>
      <h3 id="enquiryModalTitle">Enquiry</h3>
      <button type="button" title="Close" data-close>&times;</button>
    </header>
    <div class="body">
      <div class="enquiry-meta">
        <div><strong>Name:</strong> <span id="em-name">-</span></div>
        <div><strong>Email:</strong> <span id="em-email">-</span></div>
        <div><strong>Phone:</strong> <span id="em-phone">-</span></div>
        <div><strong>Property:</strong> <span id="em-property">-</span></div>
      </div>
      <div class="enquiry-full" id="em-message">-</div>
    </div>
    <div class="modal-actions">
      <a id="em-mailto" href="#" class="btn btn-primary">Reply via Email</a>
      <button type="button" class="btn btn-secondary" data-close>Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const modal = document.getElementById('enquiryModal');
  const openBtns = document.querySelectorAll('.btn-view-enquiry');
  const closeEls = modal.querySelectorAll('[data-close]');
  function open(data){
    modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
    document.getElementById('em-name').textContent = data.name || '-';
    document.getElementById('em-email').textContent = data.email || '-';
    document.getElementById('em-phone').textContent = data.phone || '-';
    document.getElementById('em-property').textContent = data.property || '-';
    document.getElementById('em-message').textContent = data.message || '-';
    const mail = encodeURIComponent(data.email || '');
    const body = encodeURIComponent(`Regarding your enquiry for "${data.property}":\n\n${data.message}\n\nâ€” Admin`);
    document.getElementById('em-mailto').href = `mailto:${mail}?subject=Regarding your enquiry&body=${body}`;
    document.body.style.overflow = 'hidden';
  }
  function close(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }
  openBtns.forEach(btn=>btn.addEventListener('click', ()=>open({
    name: btn.dataset.name, email: btn.dataset.email, phone: btn.dataset.phone, property: btn.dataset.property, message: btn.dataset.message
  })));
  closeEls.forEach(el=>el.addEventListener('click', close));
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();
</script>
{% endblock %}